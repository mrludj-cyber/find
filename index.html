<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAV Scanner (MissAV High Speed)</title>
    <style>
        /* [ìŠ¤íƒ€ì¼] ë‹¤í¬ ëª¨ë“œ */
        body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; margin: 0; padding: 10px; padding-bottom: 50px; }
        * { box-sizing: border-box; }
        a { text-decoration: none; color: inherit; }

        /* [ê²€ìƒ‰ì°½] */
        .search-panel {
            background-color: #1e1e1e; padding: 15px; border-radius: 8px; border: 1px solid #333;
            text-align: center; margin-bottom: 15px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .search-row { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .search-input {
            width: 60%; padding: 10px; border-radius: 4px; border: 1px solid #555;
            background: #2b2b2b; color: #fff; font-size: 1rem; font-weight: bold;
        }
        .search-btn {
            width: 25%; padding: 10px; background-color: #0d6efd; color: white;
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        }

        /* [í˜ì´ì§•] */
        .pagination { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; align-items: center; margin-top: 5px; }
        .page-btn {
            background: #333; color: #ccc; border: 1px solid #444; padding: 5px 10px;
            border-radius: 4px; font-size: 0.8rem; cursor: pointer;
        }
        .page-btn:active { background: #555; }
        .page-input { width: 40px; text-align: center; background: #222; border: 1px solid #444; color: #fff; padding: 4px; }

        /* [ë©”ì¸] ê·¸ë¦¬ë“œ */
        .container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-width: 1200px; margin: 0 auto;
        }
        @media (min-width: 768px) { .container { grid-template-columns: repeat(4, 1fr); } }

        /* [ì•„ì´í…œ] */
        .item {
            background-color: #1e1e1e; border-radius: 6px; overflow: hidden;
            padding: 8px; text-align: center; position: relative; border: 1px solid #333;
            display: flex; flex-direction: column;
            min-height: 200px; 
            transition: opacity 0.3s;
        }

        .filename {
            font-size: 1rem; font-weight: bold; margin-bottom: 4px; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;
        }

        .video-title {
            font-size: 0.75rem; color: #bbb; margin-bottom: 8px; min-height: 2.4rem;
            line-height: 1.2; word-break: break-all;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            transition: color 0.3s;
        }

        /* [ë¯¸ë””ì–´ ì»¨í…Œì´ë„ˆ] */
        .media-container {
            position: relative; width: 100%; padding-top: 66.66%;
            background-color: #2a2a2a; border-radius: 4px; overflow: hidden; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .media-container::after {
            content: "Scanning...";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #555; font-size: 0.8rem; font-weight: bold;
            z-index: 0;
        }

        .media-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
            cursor: pointer; z-index: 1; opacity: 0; 
            transition: opacity 0.3s ease-in;
            background-color: #000;
        }
        .media-content.loaded { opacity: 1; }

        .badge-no {
            position: absolute; top: 5px; left: 5px; width: 24px; height: 24px;
            background-color: #ffc107; color: #000; border-radius: 50%;
            font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
            z-index: 10; pointer-events: none; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: none; 
        }

        .btn-group { display: flex; gap: 4px; margin-top: auto; }
        .action-btn {
            flex: 1; padding: 8px 0; border: none; border-radius: 4px;
            font-size: 0.8rem; font-weight: bold; cursor: pointer; color: white;
            transition: background-color 0.3s;
        }
        .btn-link { background-color: #198754; }
        .btn-copy { background-color: #6c757d; }

        .loading-msg { text-align: center; color: #888; margin-top: 20px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="search-panel">
        <div class="search-row">
            <input type="text" id="keyword" class="search-input" placeholder="í’ˆë²ˆ (ì˜ˆ: milk, ipz-123)" onkeypress="handleEnter(event)">
            <button class="search-btn" onclick="startSearch()">ê²€ìƒ‰</button>
        </div>
        
        <div class="pagination" id="paginationControls" style="display:none;">
            <button class="page-btn" onclick="changePage(-1)">â—€</button>
            <span id="currentPageDisplay" style="color:#fff; font-weight:bold; margin:0 5px;">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">â–¶</button>
            <div style="width:100%; height:4px;"></div>
            <button class="page-btn" onclick="jumpPage(5)">+5</button>
            <button class="page-btn" onclick="jumpPage(10)">+10</button>
            <input type="number" id="targetPage" class="page-input" placeholder="Go">
            <button class="page-btn" onclick="goToPage()">ì´ë™</button>
        </div>
    </div>

    <div id="gallery" class="container"></div>
    <div id="loading" class="loading-msg" style="display:none;">ëª©ë¡ ìƒì„± ì¤‘...</div>

    <script>
        let currentKeyword = "";
        let currentPage = 1;
        const itemsPerPage = 20;

        // [ì„¤ì •] ì œëª© ê°€ì ¸ì˜¤ê¸° ë°°ì¹˜ ì‹œìŠ¤í…œ
        let titleQueue = [];
        let isBatchRunning = false;
        
        // ìš”ì²­ì‚¬í•­: 20ê°œ ë™ì‹œ ìš”ì²­
        const BATCH_SIZE = 20;     
        const BATCH_DELAY = 500;   // ë°°ì¹˜ ì‚¬ì´ 0.5ì´ˆ ëŒ€ê¸° (ì„œë²„ ë¶€í•˜ ë°©ì§€)
        const MAX_RETRIES = 2;     // ì¬ì‹œë„ íšŸìˆ˜

        function handleEnter(e) { if(e.key === 'Enter') startSearch(); }

        function startSearch() {
            const input = document.getElementById('keyword').value.trim();
            if (!input) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            titleQueue = [];
            isBatchRunning = false;

            const gallery = document.getElementById('gallery');
            const status = document.getElementById('loading');
            
            const specificMatch = input.match(/^([a-z]+)[-\s]?(\d+)$/i);

            gallery.innerHTML = ''; 
            status.style.display = 'block';

            if (specificMatch) {
                const code = specificMatch[1].toLowerCase();
                const num = parseInt(specificMatch[2]);
                document.getElementById('paginationControls').style.display = 'none';
                createItem(code, num);
                setTimeout(() => { status.style.display = 'none'; }, 200);
            } else {
                currentKeyword = input.toLowerCase();
                currentPage = 1;
                document.getElementById('paginationControls').style.display = 'flex';
                renderPage();
            }
        }

        function changePage(delta) { if (currentPage + delta < 1) return; currentPage += delta; renderPage(); }
        function jumpPage(delta) { currentPage += delta; renderPage(); }
        function goToPage() { const val = parseInt(document.getElementById('targetPage').value); if (val > 0) { currentPage = val; renderPage(); } }

        function renderPage() {
            titleQueue = [];
            isBatchRunning = false;

            const gallery = document.getElementById('gallery');
            const status = document.getElementById('loading');
            
            gallery.innerHTML = '';
            status.style.display = 'block';
            document.getElementById('currentPageDisplay').innerText = `Page ${currentPage}`;

            const startNum = (currentPage - 1) * itemsPerPage + 1;
            const endNum = currentPage * itemsPerPage;

            for (let i = startNum; i <= endNum; i++) {
                createItem(currentKeyword, i);
            }
            
            setTimeout(() => { status.style.display = 'none'; }, 500);
        }

        function createItem(keyword, number) {
            const numStr = String(number).padStart(3, '0');
            const fileId = `${keyword}-${numStr}`; 
            
            const uncensoredId = `${fileId}-uncensored-leak`;
            
            const uncThumb = `https://wsrv.nl/?url=fourhoi.com/${uncensoredId}/cover-t.jpg&q=70`;
            const stdThumb = `https://wsrv.nl/?url=fourhoi.com/${fileId}/cover-t.jpg&q=70`;
            const uncVideo = `https://fourhoi.com/${uncensoredId}/preview.mp4`;
            const stdVideo = `https://fourhoi.com/${fileId}/preview.mp4`;

            const stdTargetUrl = `https://missavtv.com/ko/${fileId}`;

            const div = document.createElement('div');
            div.className = 'item';
            div.style.display = 'flex';
            div.id = `card-${fileId}`;

            div.innerHTML = `
                <div class="filename">${fileId.toUpperCase()}</div>
                <div class="video-title" id="title-${fileId}">...</div>
                
                <div class="media-container" id="media-box-${fileId}">
                    <div class="badge-no" id="badge-${fileId}">ë…¸</div>
                    <img 
                        src="${stdThumb}" 
                        class="media-content" 
                        id="img-${fileId}"
                        loading="lazy"
                    >
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-link" id="btn-link-${fileId}" onclick="window.open('${stdTargetUrl}', '_blank')">ğŸ”— ì´ë™</button>
                    <button class="action-btn btn-copy" id="btn-copy-${fileId}" onclick="copyToClipboard('${stdTargetUrl}')">ğŸ“‹ ë³µì‚¬</button>
                </div>
            `;
            document.getElementById('gallery').appendChild(div);

            const imgEl = div.querySelector(`#img-${fileId}`);
            
            imgEl.onload = function() {
                this.classList.add('loaded'); 
                this.onclick = () => playVideo(this, stdVideo, stdTargetUrl);
                
                // [í] ì œëª© ê°€ì ¸ì˜¤ê¸°
                addToQueue(fileId);

                // [Fetch] ë…¸ëª¨ íƒì§€
                detectUncensoredStrict(fileId, uncThumb, uncVideo);
            };

            imgEl.onerror = function() {
                div.remove();
            };
        }

        // ========================================================
        // [1] ì œëª© ê°€ì ¸ì˜¤ê¸° (MissAV ì „ìš©, 20ê°œ ë³‘ë ¬)
        // ========================================================
        
        function addToQueue(fileId) {
            titleQueue.push({ id: fileId, retries: 0 });
            processBatch();
        }

        async function processBatch() {
            if (isBatchRunning || titleQueue.length === 0) return;
            isBatchRunning = true;

            // íì—ì„œ 20ê°œ êº¼ë‚´ê¸°
            const batch = titleQueue.splice(0, BATCH_SIZE);
            
            // ë³‘ë ¬ ìš”ì²­ ì‹¤í–‰
            const promises = batch.map(item => fetchTitleMissAV(item));
            
            await Promise.allSettled(promises);

            setTimeout(() => {
                isBatchRunning = false;
                processBatch(); 
            }, BATCH_DELAY);
        }

        async function fetchTitleMissAV(item) {
            const titleEl = document.getElementById(`title-${item.id}`);
            if(!titleEl) return;

            if (item.retries === 0) titleEl.innerText = "ìŠ¤ìº” ì¤‘...";
            else titleEl.innerText = "ì¬ì‹œë„...";

            // [ìš”ì²­] MissAV ì§í†µ
            const targetUrl = `https://missavtv.com/ko/${item.id}`;
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Net");
                
                const htmlText = await response.text();
                
                // [ì •ê·œì‹] <title> íƒœê·¸ ì¶”ì¶œ
                // MissAV íŒ¨í„´: <title>MEYD-041 ì œëª© | MissAV</title>
                const match = htmlText.match(/<title>(.*?)<\/title>/i);
                
                if (match && match[1]) {
                    let fullTitle = match[1];

                    // [ì •ì œ] MissAV ë¶ˆí•„ìš” í…ìŠ¤íŠ¸ ì œê±°
                    fullTitle = fullTitle.replace(" | MissAV", "")
                                         .replace("ë¬´ë£Œ ìŠ¤íŠ¸ë¦¬ë°", "")
                                         .replace("Online", "");

                    // [ì •ì œ] í’ˆë²ˆ ì œê±°
                    let cleanTitle = fullTitle.replace(new RegExp(item.id, 'gi'), '').trim();
                    cleanTitle = cleanTitle.replace(/^[-â€“\s]+/, ''); // ì•ìª½ íŠ¹ìˆ˜ë¬¸ì ì œê±°

                    if (cleanTitle && cleanTitle.length > 1) {
                        titleEl.innerText = cleanTitle;
                        titleEl.style.color = "#eee";
                        return; // ì„±ê³µ
                    }
                }

                throw new Error("Parse Fail");

            } catch (e) {
                // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§
                item.retries++;
                if (item.retries < MAX_RETRIES) {
                    titleQueue.push(item); // ë‹¤ì‹œ í ë’¤ë¡œ
                } else {
                    titleEl.innerHTML = "<span style='color:#666; font-size:0.7rem;'>ì •ë³´ ì—†ìŒ</span>";
                }
            }
        }

        // ========================================================
        // [2] ë…¸ëª¨ íƒì§€ (ê¸°ì¡´ ìœ ì§€)
        // ========================================================
        async function detectUncensoredStrict(fileId, uncThumbUrl, uncVideoUrl) {
            try {
                const response = await fetch(uncThumbUrl);
                if (!response.ok) return; 
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) return;

                const card = document.getElementById(`card-${fileId}`);
                if (card) {
                    const badge = card.querySelector(`#badge-${fileId}`);
                    const img = card.querySelector(`#img-${fileId}`);
                    const btnLink = card.querySelector(`#btn-link-${fileId}`);
                    const btnCopy = card.querySelector(`#btn-copy-${fileId}`);
                    
                    const uncTargetUrl = `https://missavtv.com/ko/${fileId}-uncensored-leak`;

                    if (badge) badge.style.display = 'flex';
                    if (img) img.onclick = () => playVideo(img, uncVideoUrl, uncTargetUrl);
                    if (btnLink) {
                        btnLink.onclick = () => window.open(uncTargetUrl, '_blank');
                        btnLink.style.backgroundColor = '#d63384';
                        btnLink.innerHTML = "ğŸ”— ë…¸ëª¨ ì´ë™";
                    }
                    if (btnCopy) btnCopy.onclick = () => copyToClipboard(uncTargetUrl);
                }
            } catch (e) { }
        }

        function playVideo(element, videoUrl, targetUrl) {
            const container = element.parentNode;
            container.style.background = '#000';
            const badge = container.querySelector('.badge-no');
            if(badge) badge.style.display = 'none';

            container.innerHTML = `
                <video 
                    src="${videoUrl}" 
                    autoplay loop muted playsinline 
                    class="media-content loaded"
                    style="opacity:1;"
                    onclick="window.open('${targetUrl}', '_blank');"
                ></video>
            `;
            const video = container.querySelector('video');
            video.onerror = function() {
                container.innerHTML = '<div style="color:#555; font-size:0.8rem;">ì¬ìƒ ë¶ˆê°€</div>';
            };
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ: " + text))
                .catch(err => prompt("ë³µì‚¬í•˜ì„¸ìš”:", text));
        }
    </script>
</body>
</html>
