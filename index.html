<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAV Scanner (Multi-Format Support)</title>
    <style>
        /* [ìŠ¤íƒ€ì¼] ë‹¤í¬ ëª¨ë“œ */
        body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; margin: 0; padding: 10px; padding-bottom: 50px; }
        * { box-sizing: border-box; }
        a { text-decoration: none; color: inherit; }

        /* [ê²€ìƒ‰ì°½] */
        .search-panel {
            background-color: #1e1e1e; padding: 15px; border-radius: 8px; border: 1px solid #333;
            text-align: center; margin-bottom: 15px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .search-row { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .search-input {
            width: 60%; padding: 10px; border-radius: 4px; border: 1px solid #555;
            background: #2b2b2b; color: #fff; font-size: 1rem; font-weight: bold;
        }
        .search-btn {
            width: 25%; padding: 10px; background-color: #0d6efd; color: white;
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        }

        /* [í˜ì´ì§•] */
        .pagination { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; align-items: center; margin-top: 5px; }
        .page-btn {
            background: #333; color: #ccc; border: 1px solid #444; padding: 5px 10px;
            border-radius: 4px; font-size: 0.8rem; cursor: pointer;
        }
        .page-btn:active { background: #555; }
        .page-input { width: 40px; text-align: center; background: #222; border: 1px solid #444; color: #fff; padding: 4px; }

        /* [ë©”ì¸] ê·¸ë¦¬ë“œ */
        .container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-width: 1200px; margin: 0 auto;
        }
        @media (min-width: 768px) { .container { grid-template-columns: repeat(4, 1fr); } }

        /* [ì•„ì´í…œ] */
        .item {
            background-color: #1e1e1e; border-radius: 6px; overflow: hidden;
            padding: 8px; text-align: center; position: relative; border: 1px solid #333;
            display: flex; flex-direction: column;
            min-height: 200px; 
            transition: opacity 0.3s;
        }

        .filename {
            font-size: 1rem; font-weight: bold; margin-bottom: 4px; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;
        }

        .video-title {
            font-size: 0.75rem; color: #bbb; margin-bottom: 8px; min-height: 2.4rem;
            line-height: 1.2; word-break: break-all;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            transition: color 0.3s;
        }

        /* [ë¯¸ë””ì–´ ì»¨í…Œì´ë„ˆ] */
        .media-container {
            position: relative; width: 100%; padding-top: 66.66%;
            background-color: #2a2a2a; border-radius: 4px; overflow: hidden; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .media-container::after {
            content: "Scanning...";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #555; font-size: 0.8rem; font-weight: bold;
            z-index: 0;
        }

        .media-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
            cursor: pointer; z-index: 1; opacity: 0; 
            transition: opacity 0.3s ease-in;
            background-color: #000;
        }
        .media-content.loaded { opacity: 1; }

        .badge-no {
            position: absolute; top: 5px; left: 5px; width: 24px; height: 24px;
            background-color: #ffc107; color: #000; border-radius: 50%;
            font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
            z-index: 10; pointer-events: none; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: none; 
        }

        .btn-group { display: flex; gap: 4px; margin-top: auto; }
        .action-btn {
            flex: 1; padding: 8px 0; border: none; border-radius: 4px;
            font-size: 0.8rem; font-weight: bold; cursor: pointer; color: white;
            transition: background-color 0.3s;
        }
        .btn-link { background-color: #198754; }
        .btn-copy { background-color: #6c757d; }

        .loading-msg { text-align: center; color: #888; margin-top: 20px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="search-panel">
        <div class="search-row">
            <input type="text" id="keyword" class="search-input" placeholder="í’ˆë²ˆ ì…ë ¥ (ì˜ˆ: fc2 123, ipz-001)" onkeypress="handleEnter(event)">
            <button class="search-btn" onclick="startSearch()">ê²€ìƒ‰</button>
        </div>
        
        <div class="pagination" id="paginationControls" style="display:none;">
            <button class="page-btn" onclick="changePage(-1)">â—€</button>
            <span id="currentPageDisplay" style="color:#fff; font-weight:bold; margin:0 5px;">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">â–¶</button>
            <div style="width:100%; height:4px;"></div>
            <button class="page-btn" onclick="jumpPage(5)">+5</button>
            <button class="page-btn" onclick="jumpPage(10)">+10</button>
            <input type="number" id="targetPage" class="page-input" placeholder="Go">
            <button class="page-btn" onclick="goToPage()">ì´ë™</button>
        </div>
    </div>

    <div id="gallery" class="container"></div>
    <div id="loading" class="loading-msg" style="display:none;">ëª©ë¡ ìƒì„± ì¤‘...</div>

    <script>
        let currentKeyword = "";
        let currentPage = 1;
        const itemsPerPage = 20;

        // [ë°°ì¹˜ ì‹œìŠ¤í…œ]
        let titleQueue = [];
        let isBatchRunning = false;
        const BATCH_SIZE = 20;     
        const BATCH_DELAY = 500;   
        const MAX_RETRIES = 2;

        function handleEnter(e) { if(e.key === 'Enter') startSearch(); }

        function startSearch() {
            let input = document.getElementById('keyword').value.trim();
            if (!input) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            titleQueue = [];
            isBatchRunning = false;

            const gallery = document.getElementById('gallery');
            const status = document.getElementById('loading');
            const paging = document.getElementById('paginationControls');
            
            gallery.innerHTML = ''; 
            status.style.display = 'block';

            // [ë¡œì§ ê°•í™”] ë‹¤ì–‘í•œ í’ˆë²ˆ í¬ë§· ê°ì§€
            let exactId = null;

            // 1. FC2 í¬ë§· (fc2-ppv-123456, fc2 123456 ë“±)
            const fc2Match = input.match(/^fc2[-\s\.]?(?:ppv)?[-\s\.]?(\d+)/i);
            
            // 2. Caribbeancom í¬ë§· (caribbeancom-010123-001)
            const caribMatch = input.match(/^carib(?:beancom)?[-\s\.]?(\d{6})[-\s\.]?(\d{3})/i);

            // [NEW] 3. íŠ¹ìˆ˜ ë‚ ì§œ í¬ë§· (6ìë¦¬ ìˆ«ì + (_ ë˜ëŠ” -) + 2~3ìë¦¬ ìˆ«ì)
            // ì˜ˆ: 031417_498, 011018-01, 011018-002, 012528_637
            const mixedDateMatch = input.match(/^(\d{6})([-_])(\d{2,3})$/);

            // 4. ì¼ë°˜ ë‚ ì§œí˜• í¬ë§· (041912-998) - ê¸°ì¡´ ë¡œì§ ìœ ì§€ (ìˆ«ì 6ê°œ + 3ê°œ ì´ìƒ)
            const dateMatch = input.match(/^(\d{6})[-\s\.]?(\d{3,})$/);

            // 5. Tokyo Hot (n0594)
            const nMatch = input.match(/^n(\d{3,5})$/i);

            // 6. ì¼ë°˜ í’ˆë²ˆ (ë¬¸ì+ìˆ«ì) - IPZ-123, HEYZO-103
            const stdMatch = input.match(/^([a-z]+)[-\s\.]?(\d+)$/i);

            if (fc2Match) {
                exactId = `fc2-ppv-${fc2Match[1]}`;
            } 
            else if (caribMatch) {
                exactId = `caribbeancom-${caribMatch[1]}-${caribMatch[2]}`;
            }
            else if (mixedDateMatch) {
                // [NEW] ì‚¬ìš©ìê°€ ì…ë ¥í•œ êµ¬ë¶„ì(_, -)ì™€ ìˆ«ìë¥¼ ê·¸ëŒ€ë¡œ í•©ì¹¨
                // 031417_498 -> 031417_498
                // 011018-01  -> 011018-01
                exactId = `${mixedDateMatch[1]}${mixedDateMatch[2]}${mixedDateMatch[3]}`;
            }
            else if (dateMatch) {
                exactId = `${dateMatch[1]}-${dateMatch[2]}`;
            }
            else if (nMatch) {
                exactId = `n${nMatch[1]}`;
            }
            else if (stdMatch) {
                exactId = `${stdMatch[1].toLowerCase()}-${stdMatch[2]}`;
            }

            if (exactId) {
                // [ë‹¨ì¼ ê²€ìƒ‰ ëª¨ë“œ]
                paging.style.display = 'none';
                createItemDirect(exactId);
                setTimeout(() => { status.style.display = 'none'; }, 200);
            } else {
                // [ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰ ëª¨ë“œ]
                currentKeyword = input.toLowerCase();
                currentPage = 1;
                paging.style.display = 'flex';
                renderPage();
            }
        }

        function changePage(delta) { if (currentPage + delta < 1) return; currentPage += delta; renderPage(); }
        function jumpPage(delta) { currentPage += delta; renderPage(); }
        function goToPage() { const val = parseInt(document.getElementById('targetPage').value); if (val > 0) { currentPage = val; renderPage(); } }

        function renderPage() {
            titleQueue = [];
            isBatchRunning = false;

            const gallery = document.getElementById('gallery');
            const status = document.getElementById('loading');
            
            gallery.innerHTML = '';
            status.style.display = 'block';
            document.getElementById('currentPageDisplay').innerText = `Page ${currentPage}`;

            const startNum = (currentPage - 1) * itemsPerPage + 1;
            const endNum = currentPage * itemsPerPage;

            for (let i = startNum; i <= endNum; i++) {
                // í˜ì´ì§• ëª¨ë“œì—ì„œëŠ” ìˆ«ìë¥¼ 001, 002... 3ìë¦¬ë¡œ ê°•ì œ íŒ¨ë”©
                createItemFromPaging(currentKeyword, i);
            }
            
            setTimeout(() => { status.style.display = 'none'; }, 500);
        }

        // [ë‹¨ì¼ ìƒì„±] ì •í™•í•œ IDë¥¼ ì•Œ ë•Œ
        function createItemDirect(fileId) {
            renderItemCard(fileId);
        }

        // [í˜ì´ì§• ìƒì„±] í‚¤ì›Œë“œ + ìˆ«ìë¡œ ìƒì„±í•  ë•Œ (ipz-001)
        function createItemFromPaging(keyword, number) {
            const numStr = String(number).padStart(3, '0');
            const fileId = `${keyword}-${numStr}`; 
            renderItemCard(fileId);
        }

        // [ê³µí†µ] ì¹´ë“œ ë Œë”ë§ ë¡œì§
        function renderItemCard(fileId) {
            const uncensoredId = `${fileId}-uncensored-leak`;
            
            // ì´ë¯¸ì§€/ì˜ìƒ ì†ŒìŠ¤
            const uncThumb = `https://wsrv.nl/?url=fourhoi.com/${uncensoredId}/cover-t.jpg&q=70`;
            const stdThumb = `https://wsrv.nl/?url=fourhoi.com/${fileId}/cover-t.jpg&q=70`;
            const uncVideo = `https://fourhoi.com/${uncensoredId}/preview.mp4`;
            const stdVideo = `https://fourhoi.com/${fileId}/preview.mp4`;
            const stdTargetUrl = `https://missavtv.com/ko/${fileId}`;

            const div = document.createElement('div');
            div.className = 'item';
            div.style.display = 'flex';
            div.id = `card-${fileId}`;

            div.innerHTML = `
                <div class="filename">${fileId.toUpperCase()}</div>
                <div class="video-title" id="title-${fileId}">...</div>
                
                <div class="media-container" id="media-box-${fileId}">
                    <div class="badge-no" id="badge-${fileId}">ë…¸</div>
                    <img 
                        src="${stdThumb}" 
                        class="media-content" 
                        id="img-${fileId}"
                        loading="lazy"
                    >
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-link" id="btn-link-${fileId}" onclick="window.open('${stdTargetUrl}', '_blank')">ğŸ”— ì´ë™</button>
                    <button class="action-btn btn-copy" id="btn-copy-${fileId}" onclick="copyToClipboard('${stdTargetUrl}')">ğŸ“‹ ë³µì‚¬</button>
                </div>
            `;
            document.getElementById('gallery').appendChild(div);

            const imgEl = div.querySelector(`#img-${fileId}`);
            
            imgEl.onload = function() {
                this.classList.add('loaded'); 
                this.onclick = () => playVideo(this, stdVideo, stdTargetUrl);
                addToQueue(fileId);
                detectUncensoredStrict(fileId, uncThumb, uncVideo);
            };

            imgEl.onerror = function() {
                div.remove(); // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¹´ë“œ ì‚­ì œ
            };
        }

        // ========================================================
        // [1] ì œëª© ê°€ì ¸ì˜¤ê¸° (MissAV ì „ìš©, ë°°ì¹˜ ì²˜ë¦¬)
        // ========================================================
        function addToQueue(fileId) {
            titleQueue.push({ id: fileId, retries: 0 });
            processBatch();
        }

        async function processBatch() {
            if (isBatchRunning || titleQueue.length === 0) return;
            isBatchRunning = true;

            const batch = titleQueue.splice(0, BATCH_SIZE);
            const promises = batch.map(item => fetchTitleMissAV(item));
            
            await Promise.allSettled(promises);

            setTimeout(() => {
                isBatchRunning = false;
                processBatch(); 
            }, BATCH_DELAY);
        }

        async function fetchTitleMissAV(item) {
            const titleEl = document.getElementById(`title-${item.id}`);
            if(!titleEl) return;

            if (item.retries === 0) titleEl.innerText = "ìŠ¤ìº” ì¤‘...";
            else titleEl.innerText = "ì¬ì‹œë„...";

            const targetUrl = `https://missavtv.com/ko/${item.id}`;
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Net");
                
                const htmlText = await response.text();
                let rawTitle = "";
                const ogMatch = htmlText.match(/<meta property="og:title" content="(.*?)">/i);

                if (ogMatch && ogMatch[1]) {
                    rawTitle = ogMatch[1];
                } else {
                    // 2ìˆœìœ„: <title> íƒœê·¸ ì¶”ì¶œ (Fallback)
                    const titleMatch = htmlText.match(/<title>(.*?)<\/title>/i);
                    if (titleMatch && titleMatch[1]) {
                        rawTitle = titleMatch[1];
                    }
                }              
                
                
                if (rawTitle) {
                    let cleanTitle = rawTitle.replace(" | MissAV", "").replace("ë¬´ë£Œ ìŠ¤íŠ¸ë¦¬ë°", "").replace("Online", "");
                    cleanTitle = cleanTitle.replace(new RegExp(item.id, 'gi'), '').trim();
                    cleanTitle = cleanTitle.replace(/^[-â€“\s]+/, '');

                    if (cleanTitle && cleanTitle.length > 1) {
                        // UI ì—…ë°ì´íŠ¸
                        if (targetEl) {
                            targetEl.innerText = cleanTitle;
                            targetEl.style.color = "#fff";
                        }
                        return;
                    }
                }
                throw new Error("Parse Fail");

            } catch (e) {
                item.retries++;
                if (item.retries < MAX_RETRIES) {
                    titleQueue.push(item); 
                } else {
                    titleEl.innerHTML = "<span style='color:#666; font-size:0.7rem;'>ì •ë³´ ì—†ìŒ</span>";
                }
            }
        }

        // ========================================================
        // [2] ë…¸ëª¨ íƒì§€
        // ========================================================
        async function detectUncensoredStrict(fileId, uncThumbUrl, uncVideoUrl) {
            try {
                const response = await fetch(uncThumbUrl);
                if (!response.ok) return; 
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) return;

                const card = document.getElementById(`card-${fileId}`);
                if (card) {
                    const badge = card.querySelector(`#badge-${fileId}`);
                    const img = card.querySelector(`#img-${fileId}`);
                    const btnLink = card.querySelector(`#btn-link-${fileId}`);
                    const btnCopy = card.querySelector(`#btn-copy-${fileId}`);
                    
                    const uncTargetUrl = `https://missav.live/ko/${fileId}-uncensored-leak`;

                    if (badge) badge.style.display = 'flex';
                    if (img) img.onclick = () => playVideo(img, uncVideoUrl, uncTargetUrl);
                    if (btnLink) {
                        btnLink.onclick = () => window.open(uncTargetUrl, '_blank');
                        btnLink.style.backgroundColor = '#d63384';
                        btnLink.innerHTML = "ğŸ”— ë…¸ëª¨ ì´ë™";
                    }
                    if (btnCopy) btnCopy.onclick = () => copyToClipboard(uncTargetUrl);
                }
            } catch (e) { }
        }

        function playVideo(element, videoUrl, targetUrl) {
            const container = element.parentNode;
            container.style.background = '#000';
            const badge = container.querySelector('.badge-no');
            if(badge) badge.style.display = 'none';

            container.innerHTML = `
                <video 
                    src="${videoUrl}" 
                    autoplay loop muted playsinline 
                    class="media-content loaded"
                    style="opacity:1;"
                    onclick="window.open('${targetUrl}', '_blank');"
                ></video>
            `;
            const video = container.querySelector('video');
            video.onerror = function() {
                container.innerHTML = '<div style="color:#555; font-size:0.8rem;">ì¬ìƒ ë¶ˆê°€</div>';
            };
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ: " + text))
                .catch(err => prompt("ë³µì‚¬í•˜ì„¸ìš”:", text));
        }
    </script>
</body>
</html>
